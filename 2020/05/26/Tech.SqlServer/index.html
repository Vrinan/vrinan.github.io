<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Vrinan">


    <meta name="subtitle" content="最后存活着的房门被敲">


    <meta name="description" content="最后存活着的房门被敲">



<title>Tech.SqlServer | 最后存活着的房门被敲</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 4.2.1"></head>
<body>
    <script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
    <!-- <script type="text/javascript" src="//raw.githubusercontent.com/alroy233/alroy233.github.io/master/scriptAl/canvas-nest.min.js"></script> -->
    <div class="wrapper">
        <header>
    <!-- alroy -->
    <script type="text/javascript">
        WIDGET = { FID: 'JAnPUETnam' }
    </script>
    <script type="text/javascript" src="https://apip.weatherdt.com/float/static/js/r.js?v=1111"></script>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/"></a></div>
            <div class="menu navbar-right">
                
                <a class="menu-item" href="/index">Home</a>
                
                <a class="menu-item" href="/categories">Categories</a>
                
                <a class="menu-item" href="/tags">Tags</a>
                
                <a class="menu-item" href="/Aimer">Nier</a>
                
                <a class="menu-item" href="/about">ひむら きせき</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/"></a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                <a class="menu-item" href="/index">Home</a>
                
                <a class="menu-item" href="/categories">Categories</a>
                
                <a class="menu-item" href="/tags">Tags</a>
                
                <a class="menu-item" href="/Aimer">Nier</a>
                
                <a class="menu-item" href="/about">ひむら きせき</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if (toggleMenu.classList.contains("active")) {
            toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        } else {
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">Tech.SqlServer</h1>
            
                <div class="post-meta">
                    
                        Author: <a itemprop="author" rel="author" href="/">Vrinan</a>
                    

                    
                        <span class="post-time">
                        Date: <a href="#">May 26, 2020&nbsp;&nbsp;17:28:24</a>
                        </span>
                    
                    
                        <span class="post-category">
                    Category:
                            
                                <a href="/categories/Tech/">Tech</a>
                            
                        </span>
                    
                    <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=298 height=52 src="//music.163.com/outchain/player?type=2&id=468490600&auto=1&height=32"></iframe>
                </div>
            
        </header>
        <div class="post-content">
            <h3 id="常用汇总"><a href="#常用汇总" class="headerlink" title="常用汇总"></a>常用汇总</h3><h4 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h4><h5 id="DATEDIFF-DATEADD"><a href="#DATEDIFF-DATEADD" class="headerlink" title="DATEDIFF,DATEADD"></a>DATEDIFF,DATEADD</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DATEDIFF(day,GETDATE(),ExpirationTime) AS DiffDate</span><br><span class="line">DATEADD(M,-1,ExpirationTime) as ShouldRemind</span><br></pre></td></tr></table></figure>
<h5 id="stuff-substring"><a href="#stuff-substring" class="headerlink" title="stuff/substring"></a>stuff/substring</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--STUFF从第2字符开始删除3个字符，插入123（可以实现对字符从任意位置开始的删除，添加，删除并添加）</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">stuff</span>(<span class="string">'abcdefg'</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="string">'123'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> @a <span class="keyword">nvarchar</span>(<span class="number">100</span>)</span><br><span class="line"><span class="keyword">set</span> @a = <span class="string">'啦啦啦啦$$$bbb罗罗罗罗罗'</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">substring</span>(@a,<span class="keyword">CHARINDEX</span>(<span class="string">'$$$bbb'</span>,@a), <span class="keyword">LEN</span>(@a)-<span class="keyword">CHARINDEX</span>(<span class="string">'$$$bbb'</span>,@a))</span><br></pre></td></tr></table></figure>
<h5 id="replace"><a href="#replace" class="headerlink" title="replace"></a>replace</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--replace</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">replace</span>(<span class="string">'ewqj1jphjp1jpjpoi1'</span>,<span class="string">'1'</span>,<span class="string">''</span>)</span><br></pre></td></tr></table></figure>
<h5 id="for-xml-path-同行显示列数据"><a href="#for-xml-path-同行显示列数据" class="headerlink" title="for xml path 同行显示列数据"></a>for xml path 同行显示列数据</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--同行显示指定字段相同的数据/相同字段进行相加查询</span></span><br><span class="line"><span class="keyword">select</span> Code, <span class="keyword">Name</span> = (<span class="keyword">stuff</span>((<span class="keyword">select</span> <span class="string">','</span> + <span class="keyword">Name</span> <span class="keyword">from</span> Alroy_SameLine <span class="keyword">where</span> Code =  a.Code <span class="keyword">for</span> <span class="keyword">xml</span> </span><br><span class="line"><span class="keyword">path</span>(<span class="string">''</span>)),<span class="number">1</span>,<span class="number">1</span>,<span class="string">''</span>)) <span class="keyword">from</span> Alroy_SameLine a <span class="keyword">group</span> <span class="keyword">by</span> Code </span><br><span class="line"><span class="comment">--for xml path使用方式，栅格化数据（'div'为标签名称，as后为里面标签的名词，都可自定义）</span></span><br><span class="line"><span class="keyword">select</span> Code <span class="keyword">as</span> h,<span class="keyword">Name</span> <span class="keyword">as</span> p <span class="keyword">from</span> Alroy_SameLine <span class="keyword">for</span> <span class="keyword">xml</span> <span class="keyword">path</span>(<span class="string">'div'</span>);</span><br><span class="line"><span class="keyword">select</span> Code,<span class="keyword">Name</span> <span class="keyword">from</span> Alroy_SameLine <span class="keyword">for</span> <span class="keyword">xml</span> <span class="keyword">path</span>(<span class="string">''</span>);</span><br><span class="line"><span class="keyword">select</span> <span class="string">'['</span> + Code +<span class="string">','</span>+ <span class="keyword">Name</span> + <span class="string">']'</span> <span class="keyword">from</span> Alroy_SameLine <span class="keyword">for</span> <span class="keyword">xml</span> <span class="keyword">path</span>(<span class="string">''</span>);</span><br><span class="line"><span class="keyword">select</span> <span class="string">','</span>+ <span class="keyword">Name</span> <span class="keyword">from</span> Alroy_SameLine <span class="keyword">for</span> <span class="keyword">xml</span> <span class="keyword">path</span>(<span class="string">''</span>);</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">stuff</span>((<span class="keyword">select</span> <span class="string">','</span>+ <span class="keyword">Name</span> <span class="keyword">from</span> Alroy_SameLine <span class="keyword">where</span> Code=<span class="string">'AAA'</span> <span class="keyword">for</span> <span class="keyword">xml</span> <span class="keyword">path</span>(<span class="string">''</span>)),<span class="number">1</span>,<span class="number">1</span>,<span class="string">''</span>)</span><br></pre></td></tr></table></figure>
<h5 id="四舍五入"><a href="#四舍五入" class="headerlink" title="四舍五入"></a>四舍五入</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span>   <span class="keyword">cast</span>(<span class="keyword">round</span>(<span class="number">13.5</span>,<span class="number">2</span>)   <span class="keyword">as</span>   <span class="built_in">numeric</span>(<span class="number">5</span>,<span class="number">2</span>))</span><br></pre></td></tr></table></figure>

<h4 id="针对库操作"><a href="#针对库操作" class="headerlink" title="针对库操作"></a>针对库操作</h4><h5 id="sqlserver一直显示-正在还原"><a href="#sqlserver一直显示-正在还原" class="headerlink" title="sqlserver一直显示 正在还原"></a>sqlserver一直显示 正在还原</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">restore</span> <span class="keyword">database</span> XXXXX <span class="keyword">with</span> <span class="keyword">recovery</span></span><br></pre></td></tr></table></figure>

<h4 id="可执行存储过程"><a href="#可执行存储过程" class="headerlink" title="可执行存储过程"></a>可执行存储过程</h4><h5 id="修改表名"><a href="#修改表名" class="headerlink" title="修改表名"></a>修改表名</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXEC sp_rename 'PS_MDM_Mat_new','PS_MDM_Mat'</span><br></pre></td></tr></table></figure>

<h4 id="常用语句"><a href="#常用语句" class="headerlink" title="常用语句"></a>常用语句</h4><h5 id="千分位"><a href="#千分位" class="headerlink" title="千分位"></a>千分位</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">convert</span>(<span class="keyword">nvarchar</span>,<span class="keyword">cast</span>(<span class="string">'111292981.11'</span> <span class="keyword">as</span> money),<span class="number">1</span>) Amount</span><br></pre></td></tr></table></figure>
<h5 id="查重"><a href="#查重" class="headerlink" title="查重"></a>查重</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> DataType <span class="keyword">from</span> PB_BaseData <span class="keyword">group</span> <span class="keyword">by</span> DataType <span class="keyword">having</span> <span class="keyword">count</span>(DataType)&gt;<span class="number">1</span></span><br></pre></td></tr></table></figure>
<h5 id="查询死锁的表-amp-解锁"><a href="#查询死锁的表-amp-解锁" class="headerlink" title="查询死锁的表&amp;解锁"></a>查询死锁的表&amp;解锁</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> request_session_id spid,OBJECT_NAME(resource_associated_entity_id) tableName <span class="keyword">from</span> sys.dm_tran_locks <span class="keyword">where</span> resource_type=<span class="string">'OBJECT'</span>;</span><br><span class="line"><span class="comment">--解锁</span></span><br><span class="line"><span class="keyword">declare</span> @spid  <span class="built_in">int</span> </span><br><span class="line"><span class="keyword">Set</span> @spid  = <span class="number">62</span><span class="comment">--此处为以上查出的锁表进程</span></span><br><span class="line"><span class="keyword">declare</span> @<span class="keyword">sql</span> <span class="built_in">varchar</span>(<span class="number">1000</span>)</span><br><span class="line"><span class="keyword">set</span> @<span class="keyword">sql</span>=<span class="string">'kill '</span>+<span class="keyword">cast</span>(@spid  <span class="keyword">as</span> <span class="built_in">varchar</span>)</span><br><span class="line">exec(@<span class="keyword">sql</span>)</span><br></pre></td></tr></table></figure>
<h5 id="查询数据库所有表名和视图"><a href="#查询数据库所有表名和视图" class="headerlink" title="查询数据库所有表名和视图"></a>查询数据库所有表名和视图</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> TABLE_NAME=<span class="string">'XLX_MDM_MAT_Middle'</span></span><br></pre></td></tr></table></figure>
<h5 id="查看表的所有列"><a href="#查看表的所有列" class="headerlink" title="查看表的所有列"></a>查看表的所有列</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">Name</span> <span class="keyword">FROM</span> SysColumns <span class="keyword">WHERE</span> <span class="keyword">id</span>=Object_Id(<span class="string">'XLX_MDM_MAT_Middle'</span>)</span><br></pre></td></tr></table></figure>
<h5 id="查询表具体信息"><a href="#查询表具体信息" class="headerlink" title="查询表具体信息"></a>查询表具体信息</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> sysobjects <span class="keyword">where</span> <span class="keyword">name</span>=<span class="string">'XLX_MDM_MAT_Middle'</span></span><br></pre></td></tr></table></figure>

<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><h5 id="删除字符串里的回车-换行"><a href="#删除字符串里的回车-换行" class="headerlink" title="删除字符串里的回车+换行"></a>删除字符串里的回车+换行</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update PS_PUR_BOM <span class="keyword">set</span>  MatCode=REPLACE(MatCode, CHAR(13) + CHAR(10), '')</span><br></pre></td></tr></table></figure>


<h3 id="Cursor-游标"><a href="#Cursor-游标" class="headerlink" title="Cursor 游标"></a>Cursor 游标</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> MyCur <span class="keyword">cursor</span> <span class="keyword">for</span> <span class="comment">--建立名称为MyCur的游标</span></span><br><span class="line"> <span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> xlx_pur_order <span class="keyword">where</span>     <span class="comment">--取循环数据行</span></span><br><span class="line"> <span class="keyword">open</span> MyCur <span class="comment">--打开游标</span></span><br><span class="line"> <span class="keyword">FETCH</span> <span class="keyword">NEXT</span> <span class="keyword">FROM</span> MyCur <span class="keyword">INTO</span> @<span class="keyword">id</span>  <span class="comment">--取游标指向的当前行的数据赋值给变量@id</span></span><br><span class="line"> <span class="keyword">WHILE</span>(@@FETCH_STATUS = <span class="number">0</span>) <span class="comment">--游标读取下一条数据是否成功</span></span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">  <span class="comment">--要执行循环的SQL语句</span></span><br><span class="line">    <span class="keyword">FETCH</span> <span class="keyword">NEXT</span> <span class="keyword">FROM</span> MyCur <span class="keyword">INTO</span> @<span class="keyword">id</span>  <span class="comment">--取游标指向的当前行的数据赋值给变量@id</span></span><br><span class="line">  <span class="keyword">END</span></span><br><span class="line"> <span class="keyword">CLOSE</span> MyCur <span class="comment">--关闭游标MyCur</span></span><br><span class="line"> <span class="keyword">DEALLOCATE</span> MyCur <span class="comment">--删除游标MyCur</span></span><br></pre></td></tr></table></figure>

<h3 id="Trigger-触发器"><a href="#Trigger-触发器" class="headerlink" title="Trigger 触发器"></a>Trigger 触发器</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--1、创建一个触发器</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> Test_Trigger</span><br><span class="line"><span class="keyword">ON</span> a</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">INSERT</span>, <span class="keyword">UPDATE</span>, <span class="keyword">DELETE</span> </span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line">print  <span class="string">'Don''t forget to print a report for the distributors.'</span></span><br><span class="line"><span class="comment">--insert into a values('3','2','6')</span></span><br><span class="line"><span class="comment">--2、重命名触发器</span></span><br><span class="line"><span class="comment">--3、删除触发器,可以先判断是否存在</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">Exists</span>(<span class="keyword">select</span> <span class="keyword">name</span> <span class="keyword">from</span> sysobjects <span class="keyword">where</span> <span class="keyword">name</span>=<span class="string">'Test_Trigger'</span> <span class="keyword">and</span> xtype=<span class="string">'TR'</span>)</span><br><span class="line">print <span class="string">'存在'</span></span><br><span class="line"><span class="comment">--INSTEAD OF</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">trigger</span> Tr_insteadof</span><br><span class="line"><span class="keyword">on</span> a</span><br><span class="line">instead <span class="keyword">of</span> <span class="keyword">delete</span></span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> a <span class="keyword">values</span>(<span class="string">'3'</span>,<span class="string">'2'</span>,<span class="string">'1'</span>)</span><br><span class="line"><span class="comment">--select * from a</span></span><br><span class="line"><span class="comment">--delete from a where id='1'</span></span><br><span class="line"><span class="comment">--4、检查是否更新了某一列，用于 insert 或 update，不能用于 delete。例：</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">trigger</span> Tr_ifupdate</span><br><span class="line"><span class="keyword">on</span> a</span><br><span class="line"><span class="keyword">for</span> <span class="keyword">update</span></span><br><span class="line"><span class="keyword">as</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">update</span>(<span class="keyword">id</span>) <span class="keyword">or</span> <span class="keyword">update</span>(<span class="keyword">value</span>)</span><br><span class="line">print <span class="string">'更新了 id 或 title 列'</span></span><br><span class="line"><span class="comment">--update a set id='10' where id='1'</span></span><br><span class="line"><span class="comment">--5、查看当前数据库有哪些触发器</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> sysobjects <span class="keyword">where</span> xtype=<span class="string">'TR'</span></span><br><span class="line">sp_helptext Test_Trigger</span><br><span class="line"><span class="comment">--6、触发器回滚</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">trigger</span> tr_rollback</span><br><span class="line"><span class="keyword">on</span> a</span><br><span class="line"><span class="keyword">for</span> <span class="keyword">update</span></span><br><span class="line"><span class="keyword">as</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">update</span>(userName)</span><br><span class="line">        <span class="keyword">rollback</span> tran</span><br><span class="line"><span class="comment">--7、表复制与触发器</span></span><br><span class="line"><span class="comment">--由于 select..into..from.. 要求目的表不存在，所以不讨论触发器。</span></span><br><span class="line"><span class="comment">--而 insert..into..select..form 的目的表，很可能含有触发器，要说明的是，如果目的表含有 insert 类型的触发器，那么对于一次批量插入的记录，只有最后一条记录会触发触发器。</span></span><br><span class="line"><span class="comment">--8、我们不能在视图上创建 FOR 触发器，而应该创建 INSTEAD OF</span></span><br><span class="line"><span class="comment">--9、禁用和启用触发器</span></span><br><span class="line"><span class="comment">--禁用：alter table 表名 disable trigger 触发器名称</span></span><br><span class="line"><span class="comment">--启用：alter table 表名 enable trigger 触发器名称</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">永荣针对表pb_message，角标控制器：</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TRIGGER</span> [dbo].[Tr_YRservicePack]</span><br><span class="line"><span class="keyword">ON</span> [dbo].[PB_Messages]</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">INSERT</span></span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line">	<span class="keyword">declare</span> @ToHumanId <span class="built_in">varchar</span>(<span class="number">50</span>),@code <span class="built_in">varchar</span>(<span class="number">50</span>),@<span class="keyword">count</span> <span class="built_in">varchar</span>(<span class="number">50</span>);</span><br><span class="line">	<span class="keyword">select</span> @ToHumanId = ToHumanId <span class="keyword">from</span> inserted;</span><br><span class="line">	<span class="keyword">select</span> @code=Code <span class="keyword">from</span> PB_User <span class="keyword">where</span> HumanId <span class="keyword">in</span>(<span class="keyword">select</span> ToHumanId <span class="keyword">from</span> pb_messages <span class="keyword">where</span> ToHumanId=@ToHumanId)</span><br><span class="line">	<span class="keyword">select</span> @<span class="keyword">count</span>=<span class="keyword">count</span>(*) <span class="keyword">from</span> pb_messages <span class="keyword">where</span> ToHumanId=@ToHumanId <span class="keyword">and</span> IsSend = <span class="number">0</span></span><br><span class="line">	exec IPCC_WEBSERVICE_PACKID @code,@<span class="keyword">count</span>,<span class="string">'outText'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TRIGGER</span> [dbo].[Tr_YRservicePackDelete]</span><br><span class="line"><span class="keyword">ON</span> [dbo].[PB_Messages]</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">delete</span></span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line">	<span class="keyword">declare</span> @ToHumanId <span class="built_in">varchar</span>(<span class="number">50</span>),@code <span class="built_in">varchar</span>(<span class="number">50</span>),@<span class="keyword">count</span> <span class="built_in">varchar</span>(<span class="number">50</span>);</span><br><span class="line">	<span class="keyword">select</span> @ToHumanId = ToHumanId <span class="keyword">from</span> deleted;</span><br><span class="line">	<span class="keyword">select</span> @code=Code <span class="keyword">from</span> PB_User <span class="keyword">where</span> HumanId <span class="keyword">in</span>(<span class="keyword">select</span> ToHumanId <span class="keyword">from</span> pb_messages <span class="keyword">where</span> ToHumanId=@ToHumanId)</span><br><span class="line">	<span class="keyword">select</span> @<span class="keyword">count</span>=<span class="keyword">count</span>(*) <span class="keyword">from</span> pb_messages <span class="keyword">where</span> ToHumanId=@ToHumanId <span class="keyword">and</span> IsSend = <span class="number">0</span></span><br><span class="line">	exec IPCC_WEBSERVICE_PACKID @code,@<span class="keyword">count</span>,<span class="string">'outText'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TRIGGER</span> [dbo].[Tr_YRservicePackUpdate]</span><br><span class="line"><span class="keyword">ON</span> [dbo].[PB_Messages]</span><br><span class="line"><span class="keyword">FOR</span> <span class="keyword">update</span></span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line">	<span class="keyword">declare</span> @ToHumanId <span class="built_in">varchar</span>(<span class="number">50</span>),@code <span class="built_in">varchar</span>(<span class="number">50</span>),@<span class="keyword">count</span> <span class="built_in">varchar</span>(<span class="number">50</span>);</span><br><span class="line">	<span class="keyword">SELECT</span> @ToHumanId=ToHumanId <span class="keyword">from</span> inserted <span class="comment">----获取修改后的人员ID</span></span><br><span class="line">	<span class="keyword">select</span> @code=Code <span class="keyword">from</span> PB_User <span class="keyword">where</span> HumanId <span class="keyword">in</span>(<span class="keyword">select</span> ToHumanId <span class="keyword">from</span> pb_messages <span class="keyword">where</span> ToHumanId=@ToHumanId)</span><br><span class="line">	<span class="keyword">select</span> @<span class="keyword">count</span>=<span class="keyword">count</span>(*) <span class="keyword">from</span> pb_messages <span class="keyword">where</span> ToHumanId=@ToHumanId <span class="keyword">and</span> IsSend = <span class="number">0</span></span><br><span class="line">	exec IPCC_WEBSERVICE_PACKID @code,@<span class="keyword">count</span>,<span class="string">'outText'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> [dbo].[IPCC_WEBSERVICE_PACKID](@UserCode <span class="built_in">VARCHAR</span>(<span class="number">100</span>),@badge <span class="built_in">varchar</span>(<span class="number">10</span>),@outText <span class="built_in">VARCHAR</span>(<span class="number">2000</span>) <span class="keyword">OUT</span>)</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">  <span class="comment">--@ts,时间戳</span></span><br><span class="line">  <span class="keyword">declare</span> @four <span class="built_in">varchar</span>(<span class="number">10</span>) = <span class="keyword">stuff</span>(<span class="keyword">replace</span>(<span class="keyword">stuff</span>(<span class="keyword">CONVERT</span>(<span class="built_in">VARCHAR</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">20</span>),<span class="number">1</span>,<span class="number">11</span>,<span class="string">''</span>),<span class="string">':'</span>,<span class="string">''</span>),<span class="number">4</span>,<span class="number">2</span>,<span class="string">''</span>)</span><br><span class="line">  <span class="keyword">DECLARE</span> @ts <span class="built_in">varchar</span>(<span class="number">100</span>) =  <span class="keyword">CONVERT</span>(<span class="built_in">VARCHAR</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">112</span>)+@four+<span class="string">''</span></span><br><span class="line">  <span class="comment">--@token</span></span><br><span class="line">  <span class="keyword">declare</span> @<span class="keyword">str</span> <span class="built_in">varchar</span>(<span class="number">2000</span>)=<span class="string">'@_@'</span>+@ts+<span class="string">'2a95642cd1df45ab962c224bc4301292'</span></span><br><span class="line">  <span class="keyword">DECLARE</span> @token <span class="built_in">varchar</span>(<span class="number">1000</span>)</span><br><span class="line">  <span class="keyword">set</span> @token=<span class="keyword">substring</span>(sys.fn_sqlvarbasetostr(HashBytes(<span class="string">'MD5'</span>,@<span class="keyword">str</span>)),<span class="number">3</span>,<span class="number">32</span>)</span><br><span class="line">  <span class="keyword">DECLARE</span> @modulecode <span class="built_in">VARCHAR</span>(<span class="number">500</span>) = <span class="string">'pms'</span></span><br><span class="line">  <span class="keyword">DECLARE</span> @returnText <span class="built_in">VARCHAR</span>(<span class="number">2000</span>)</span><br><span class="line">  <span class="keyword">DECLARE</span> @<span class="keyword">status</span> <span class="built_in">int</span></span><br><span class="line">  <span class="keyword">DECLARE</span> @urlStr <span class="built_in">VARCHAR</span>(<span class="number">255</span>)</span><br><span class="line">  <span class="keyword">SET</span> @urlStr=<span class="string">'http://117.27.151.7:9106/ssoBadge/updateBadgePub.do?token='</span>+@token+<span class="string">'&amp;ts='</span>+@ts+<span class="string">'&amp;modulecode=pms&amp;badge='</span>+@badge+<span class="string">'&amp;usercode='</span>+@UserCode+<span class="string">''</span></span><br><span class="line">  EXEC P_GET_HttpRequestData @urlStr,@<span class="keyword">status</span>, @returnText <span class="keyword">OUTPUT</span>;</span><br><span class="line">  <span class="keyword">SET</span> @outText = @returnText;</span><br><span class="line">  print @urlStr</span><br><span class="line">  print @outText <span class="comment">---打印</span></span><br><span class="line"><span class="keyword">END</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> P_GET_HttpRequestData(</span><br><span class="line">	@<span class="keyword">URL</span> <span class="built_in">varchar</span>(<span class="number">500</span>),</span><br><span class="line">	@<span class="keyword">status</span> <span class="built_in">int</span>=<span class="number">0</span> <span class="keyword">OUT</span>,</span><br><span class="line">	@returnText <span class="built_in">varchar</span>(<span class="number">2000</span>)=<span class="string">''</span> <span class="keyword">OUT</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">AS</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">DECLARE</span> @<span class="keyword">object</span> <span class="built_in">int</span>,</span><br><span class="line">	@errSrc <span class="built_in">int</span></span><br><span class="line">	<span class="comment">/*初始化对*/</span></span><br><span class="line">	EXEC @<span class="keyword">status</span> = SP_OACreate <span class="string">'Msxml2.ServerXMLHTTP.3.0'</span>, @<span class="keyword">object</span> <span class="keyword">OUT</span></span><br><span class="line">	<span class="keyword">IF</span> @<span class="keyword">status</span> &lt;&gt; <span class="number">0</span></span><br><span class="line">	<span class="keyword">BEGIN</span></span><br><span class="line">	 EXEC SP_OAGetErrorInfo @<span class="keyword">object</span>, @errSrc <span class="keyword">OUT</span>, @returnText <span class="keyword">OUT</span></span><br><span class="line">	 <span class="keyword">RETURN</span></span><br><span class="line">	<span class="keyword">END</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*创建链接*/</span></span><br><span class="line">	EXEC @<span class="keyword">status</span>= SP_OAMethod @<span class="keyword">object</span>,<span class="string">'open'</span>,<span class="literal">NULL</span>,<span class="string">'GET'</span>,@<span class="keyword">URL</span></span><br><span class="line">	<span class="keyword">IF</span> @<span class="keyword">status</span> &lt;&gt; <span class="number">0</span></span><br><span class="line">	<span class="keyword">BEGIN</span></span><br><span class="line">	 EXEC SP_OAGetErrorInfo @<span class="keyword">object</span>, @errSrc <span class="keyword">OUT</span>, @returnText <span class="keyword">OUT</span></span><br><span class="line">	 <span class="keyword">RETURN</span></span><br><span class="line">	<span class="keyword">END</span></span><br><span class="line">	EXEC @<span class="keyword">status</span>=SP_OAMethod @<span class="keyword">object</span>,<span class="string">'setRequestHeader'</span>,<span class="string">'Content-Type'</span>,<span class="string">'application/x-www-form-urlencoded'</span></span><br><span class="line">	<span class="comment">/*发起请求*/</span></span><br><span class="line">	EXEC @<span class="keyword">status</span>= SP_OAMethod @<span class="keyword">object</span>,<span class="string">'send'</span>,<span class="literal">NULL</span> </span><br><span class="line">	<span class="keyword">IF</span> @<span class="keyword">status</span> &lt;&gt; <span class="number">0</span> </span><br><span class="line">	<span class="keyword">BEGIN</span> </span><br><span class="line">	 EXEC SP_OAGetErrorInfo @<span class="keyword">object</span>, @errSrc <span class="keyword">OUT</span>, @returnText <span class="keyword">OUT</span></span><br><span class="line">	 <span class="keyword">RETURN</span></span><br><span class="line">	<span class="keyword">END</span></span><br><span class="line">     </span><br><span class="line">	<span class="comment">/*获取返回*/</span></span><br><span class="line">	EXEC @<span class="keyword">status</span>= SP_OAGetProperty @<span class="keyword">object</span>,<span class="string">'responseText'</span>,@returnText <span class="keyword">OUT</span></span><br><span class="line">	<span class="keyword">IF</span> @<span class="keyword">status</span> &lt;&gt; <span class="number">0</span> </span><br><span class="line">	<span class="keyword">BEGIN</span> </span><br><span class="line">	 EXEC SP_OAGetErrorInfo @<span class="keyword">object</span>, @errSrc <span class="keyword">OUT</span>, @returnText <span class="keyword">OUT</span></span><br><span class="line">	 <span class="keyword">RETURN</span></span><br><span class="line">	<span class="keyword">END</span></span><br><span class="line"><span class="keyword">END</span>;</span><br></pre></td></tr></table></figure>

<h3 id="getdate-格式转换"><a href="#getdate-格式转换" class="headerlink" title="getdate()格式转换"></a>getdate()格式转换</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">0</span>): <span class="number">05</span> <span class="number">16</span> <span class="number">2006</span> <span class="number">10</span>:<span class="number">57</span>AM</span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">1</span>): <span class="number">05</span>/<span class="number">16</span>/<span class="number">06</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">2</span>): <span class="number">06.05</span><span class="number">.16</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">3</span>): <span class="number">16</span>/<span class="number">05</span>/<span class="number">06</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">4</span>): <span class="number">16.05</span><span class="number">.06</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">5</span>): <span class="number">16</span><span class="number">-05</span><span class="number">-06</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">6</span>): <span class="number">16</span> <span class="number">05</span> <span class="number">06</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">7</span>): <span class="number">05</span> <span class="number">16</span>, <span class="number">06</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">8</span>): <span class="number">10</span>:<span class="number">57</span>:<span class="number">46</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">9</span>): <span class="number">05</span> <span class="number">16</span> <span class="number">2006</span> <span class="number">10</span>:<span class="number">57</span>:<span class="number">46</span>:<span class="number">827</span>AM</span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">10</span>): <span class="number">05</span><span class="number">-16</span><span class="number">-06</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">11</span>): <span class="number">06</span>/<span class="number">05</span>/<span class="number">16</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">12</span>): <span class="number">060516</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">13</span>): <span class="number">16</span> <span class="number">05</span> <span class="number">2006</span> <span class="number">10</span>:<span class="number">57</span>:<span class="number">46</span>:<span class="number">937</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">14</span>): <span class="number">10</span>:<span class="number">57</span>:<span class="number">46</span>:<span class="number">967</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">20</span>): <span class="number">2006</span><span class="number">-05</span><span class="number">-16</span> <span class="number">10</span>:<span class="number">57</span>:<span class="number">47</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">21</span>): <span class="number">2006</span><span class="number">-05</span><span class="number">-16</span> <span class="number">10</span>:<span class="number">57</span>:<span class="number">47.157</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">22</span>): <span class="number">05</span>/<span class="number">16</span>/<span class="number">06</span> <span class="number">10</span>:<span class="number">57</span>:<span class="number">47</span> AM</span><br><span class="line">※※<span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">23</span>): <span class="number">2006</span><span class="number">-05</span><span class="number">-16</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">24</span>): <span class="number">10</span>:<span class="number">57</span>:<span class="number">47</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">25</span>): <span class="number">2006</span><span class="number">-05</span><span class="number">-16</span> <span class="number">10</span>:<span class="number">57</span>:<span class="number">47.250</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">100</span>): <span class="number">05</span> <span class="number">16</span> <span class="number">2006</span> <span class="number">10</span>:<span class="number">57</span>AM</span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">101</span>): <span class="number">05</span>/<span class="number">16</span>/<span class="number">2006</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">102</span>): <span class="number">2006.05</span><span class="number">.16</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">103</span>): <span class="number">16</span>/<span class="number">05</span>/<span class="number">2006</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">104</span>): <span class="number">16.05</span><span class="number">.2006</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">105</span>): <span class="number">16</span><span class="number">-05</span><span class="number">-2006</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">106</span>): <span class="number">16</span> <span class="number">05</span> <span class="number">2006</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">107</span>): <span class="number">05</span> <span class="number">16</span>, <span class="number">2006</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">108</span>): <span class="number">10</span>:<span class="number">57</span>:<span class="number">49</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">109</span>): <span class="number">05</span> <span class="number">16</span> <span class="number">2006</span> <span class="number">10</span>:<span class="number">57</span>:<span class="number">49</span>:<span class="number">437</span>AM</span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">110</span>): <span class="number">05</span><span class="number">-16</span><span class="number">-2006</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">111</span>): <span class="number">2006</span>/<span class="number">05</span>/<span class="number">16</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">112</span>): <span class="number">20060516</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">113</span>): <span class="number">16</span> <span class="number">05</span> <span class="number">2006</span> <span class="number">10</span>:<span class="number">57</span>:<span class="number">49</span>:<span class="number">513</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">114</span>): <span class="number">10</span>:<span class="number">57</span>:<span class="number">49</span>:<span class="number">547</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">120</span>): <span class="number">2006</span><span class="number">-05</span><span class="number">-16</span> <span class="number">10</span>:<span class="number">57</span>:<span class="number">49</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">121</span>): <span class="number">2006</span><span class="number">-05</span><span class="number">-16</span> <span class="number">10</span>:<span class="number">57</span>:<span class="number">49.700</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">126</span>): <span class="number">2006</span><span class="number">-05</span><span class="number">-16</span>T10:<span class="number">57</span>:<span class="number">49.827</span></span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">130</span>): <span class="number">18</span> ???? ?????? <span class="number">1427</span> <span class="number">10</span>:<span class="number">57</span>:<span class="number">49</span>:<span class="number">907</span>AM</span><br><span class="line"><span class="keyword">Select</span> <span class="keyword">CONVERT</span>(<span class="built_in">varchar</span>(<span class="number">100</span>), <span class="keyword">GETDATE</span>(), <span class="number">131</span>): <span class="number">18</span>/<span class="number">04</span>/<span class="number">1427</span> <span class="number">10</span>:<span class="number">57</span>:<span class="number">49</span>:<span class="number">920</span>AM</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">convert</span>(<span class="keyword">nvarchar</span>(<span class="number">6</span>),a.Month,<span class="number">112</span>) <span class="keyword">as</span> ym <span class="comment">--201901</span></span><br></pre></td></tr></table></figure>


<h3 id="索引的查询与创建"><a href="#索引的查询与创建" class="headerlink" title="索引的查询与创建"></a>索引的查询与创建</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--查询创建索引</span></span><br><span class="line"><span class="keyword">select</span>   <span class="keyword">distinct</span></span><br><span class="line"> <span class="string">'CREATE NONCLUSTERED INDEX ['</span>+ <span class="keyword">replace</span>( <span class="keyword">substring</span>(a.statement ,<span class="keyword">charindex</span>( <span class="string">'[dbo]'</span>,a.statement) +<span class="number">7</span> ,<span class="keyword">len</span>(a.statement)),<span class="string">']'</span>,<span class="string">''</span>) + <span class="string">'_'</span>+  <span class="keyword">Convert</span>(<span class="built_in">varchar</span>(<span class="number">30</span>), a.object_id) +<span class="string">' ON '</span> + </span><br><span class="line"> <span class="keyword">substring</span>(a.statement ,<span class="keyword">charindex</span>( <span class="string">'[dbo]'</span>,a.statement),<span class="keyword">len</span>(a.statement)) + <span class="string">'('</span> + a.equality_columns +<span class="string">')'</span> <span class="keyword">as</span> aa <span class="keyword">from</span></span><br><span class="line"><span class="comment">--a.index_handle, a.object_id, a.statement,a.equality_columns,c.avg_system_impact,c.avg_total_system_cost,c.avg_total_user_cost,avg_user_impact from </span></span><br><span class="line">sys.dm_db_missing_index_details  a <span class="keyword">join</span> sys.dm_db_missing_index_groups b <span class="keyword">on</span> a.index_handle=b.index_handle</span><br><span class="line"><span class="keyword">join</span> sys.dm_db_missing_index_group_stats c <span class="keyword">on</span>  b.index_group_handle=c.group_handle</span><br><span class="line"><span class="keyword">where</span>  a.equality_columns <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line"> <span class="keyword">and</span> a.statement <span class="keyword">like</span> <span class="string">'%PowerPMDB_PMIS]%'</span>   <span class="comment">-- 左侧的库名， 不加这个约束，就针对整个数据库了。</span></span><br><span class="line"><span class="comment">--创建索引</span></span><br><span class="line"><span class="keyword">CREATE</span> NONCLUSTERED <span class="keyword">INDEX</span> [IX_PS_MDM_Mat_Middle_Id] <span class="keyword">ON</span> [dbo].[PS_MDM_Mat]</span><br><span class="line">(</span><br><span class="line">	[Middle_Id] <span class="keyword">ASC</span></span><br><span class="line">)<span class="keyword">WITH</span> (PAD_INDEX = <span class="keyword">OFF</span>, STATISTICS_NORECOMPUTE = <span class="keyword">OFF</span>, SORT_IN_TEMPDB = <span class="keyword">OFF</span>, DROP_EXISTING = <span class="keyword">OFF</span>, <span class="keyword">ONLINE</span> = <span class="keyword">OFF</span>, ALLOW_ROW_LOCKS = <span class="keyword">ON</span>, ALLOW_PAGE_LOCKS = <span class="keyword">ON</span>)</span><br><span class="line"><span class="keyword">GO</span></span><br></pre></td></tr></table></figure>
        </div>

        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                    
                        <a href="/tags/Tech/"># Tech</a>
                    
                        <a href="/tags/Sql/"># Sql</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2020/05/26/Tech.Net/">Tech.Net</a>
            
            
            <a class="next" rel="next" href="/2019/06/29/Tech.CMD/">Tech.CMD</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <!-- <span>© Vrinan|Powered by Hexo</span> -->
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <span id="busuanzi_container_site_pv">x<span id="busuanzi_value_site_pv"></span></span>
        <span class="post-meta-divider">|</span>
        <span id="busuanzi_container_site_uv">s<span id="busuanzi_value_site_uv"></span></span>
    </div>
</footer>
    </div>
</body>
</html>
